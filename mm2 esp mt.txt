local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LP = Players.LocalPlayer
local roles = {}

local Murder, Sheriff, Hero
local characterConnections = {}

local playerGui = game:GetService("CoreGui")
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DragButtonGui"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- ===== Botón moderno mejorado =====
local buttonFrame = Instance.new("Frame")
buttonFrame.Name = "ButtonContainer"
buttonFrame.Size = UDim2.new(0, 200, 0, 70)
buttonFrame.Position = UDim2.new(0.5, -100, 0.1, 0)
buttonFrame.BackgroundTransparency = 1
buttonFrame.Parent = screenGui
buttonFrame.ZIndex = 10

-- Botón principal
local textButton = Instance.new("TextButton")
textButton.Name = "HighlightButton"
textButton.Size = UDim2.new(1, 0, 1, 0)
textButton.Position = UDim2.new(0, 0, 0, 0)
textButton.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
textButton.BorderSizePixel = 0
textButton.AutoButtonColor = false
textButton.Text = ""
textButton.Parent = buttonFrame

-- Esquinas redondeadas
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 15)
corner.Parent = textButton

-- Gradiente sutil
local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(40, 40, 50)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(25, 25, 30))
}
gradient.Rotation = 45
gradient.Parent = textButton

-- Borde brillante
local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(100, 100, 120)
stroke.Thickness = 2
stroke.Transparency = 0.5
stroke.Parent = textButton

-- Icono del ESP
local icon = Instance.new("ImageLabel")
icon.Name = "Icon"
icon.Size = UDim2.new(0, 30, 0, 30)
icon.Position = UDim2.new(0, 15, 0.5, -15)
icon.BackgroundTransparency = 1
icon.Image = "rbxassetid://3926305904" -- Icono de ojo
icon.ImageColor3 = Color3.fromRGB(150, 150, 160)
icon.Parent = textButton

-- Texto del estado
local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "StatusLabel"
statusLabel.Size = UDim2.new(1, -60, 0.5, 0)
statusLabel.Position = UDim2.new(0, 55, 0, 5)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "ESP"
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 210)
statusLabel.TextSize = 18
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = textButton

-- Subtexto
local stateLabel = Instance.new("TextLabel")
stateLabel.Name = "StateLabel"
stateLabel.Size = UDim2.new(1, -60, 0.5, 0)
stateLabel.Position = UDim2.new(0, 55, 0.5, -5)
stateLabel.BackgroundTransparency = 1
stateLabel.Text = "Desactivado"
stateLabel.TextColor3 = Color3.fromRGB(120, 120, 130)
stateLabel.TextSize = 14
stateLabel.Font = Enum.Font.Gotham
stateLabel.TextXAlignment = Enum.TextXAlignment.Left
stateLabel.Parent = textButton

-- Indicador de estado (punto)
local indicator = Instance.new("Frame")
indicator.Name = "Indicator"
indicator.Size = UDim2.new(0, 10, 0, 10)
indicator.Position = UDim2.new(1, -20, 0.5, -5)
indicator.BackgroundColor3 = Color3.fromRGB(150, 150, 160)
indicator.BorderSizePixel = 0
indicator.Parent = textButton

local indicatorCorner = Instance.new("UICorner")
indicatorCorner.CornerRadius = UDim.new(1, 0)
indicatorCorner.Parent = indicator

-- Variables de arrastre
local dragging = false
local dragInput, dragStart, startPos

-- Estado del ESP
local isHighlightActive = false
local updateConnection = nil

-- ===== Animaciones =====
local function animateButton(isActive)
    local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out)
    
    if isActive then
        -- Activado
        TweenService:Create(stroke, tweenInfo, {Color = Color3.fromRGB(0, 255, 150)}):Play()
        TweenService:Create(stroke, tweenInfo, {Transparency = 0}):Play()
        TweenService:Create(indicator, tweenInfo, {BackgroundColor3 = Color3.fromRGB(0, 255, 150)}):Play()
        TweenService:Create(icon, tweenInfo, {ImageColor3 = Color3.fromRGB(0, 255, 150)}):Play()
        TweenService:Create(statusLabel, tweenInfo, {TextColor3 = Color3.fromRGB(0, 255, 150)}):Play()
        TweenService:Create(stateLabel, tweenInfo, {TextColor3 = Color3.fromRGB(100, 255, 180)}):Play()
        stateLabel.Text = "Activado"
        
        -- Efecto de pulso
        local pulse = TweenService:Create(indicator, TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
            Size = UDim2.new(0, 12, 0, 12),
            Position = UDim2.new(1, -21, 0.5, -6)
        })
        pulse:Play()
    else
        -- Desactivado
        TweenService:Create(stroke, tweenInfo, {Color = Color3.fromRGB(100, 100, 120)}):Play()
        TweenService:Create(stroke, tweenInfo, {Transparency = 0.5}):Play()
        TweenService:Create(indicator, tweenInfo, {BackgroundColor3 = Color3.fromRGB(150, 150, 160)}):Play()
        TweenService:Create(indicator, tweenInfo, {Size = UDim2.new(0, 10, 0, 10)}):Play()
        TweenService:Create(indicator, tweenInfo, {Position = UDim2.new(1, -20, 0.5, -5)}):Play()
        TweenService:Create(icon, tweenInfo, {ImageColor3 = Color3.fromRGB(150, 150, 160)}):Play()
        TweenService:Create(statusLabel, tweenInfo, {TextColor3 = Color3.fromRGB(200, 200, 210)}):Play()
        TweenService:Create(stateLabel, tweenInfo, {TextColor3 = Color3.fromRGB(120, 120, 130)}):Play()
        stateLabel.Text = "Desactivado"
    end
end

-- Efecto hover
textButton.MouseEnter:Connect(function()
    if not dragging then
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        TweenService:Create(textButton, tweenInfo, {Size = UDim2.new(1, 5, 1, 5)}):Play()
        TweenService:Create(textButton, tweenInfo, {Position = UDim2.new(0, -2.5, 0, -2.5)}):Play()
    end
end)

textButton.MouseLeave:Connect(function()
    if not dragging then
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        TweenService:Create(textButton, tweenInfo, {Size = UDim2.new(1, 0, 1, 0)}):Play()
        TweenService:Create(textButton, tweenInfo, {Position = UDim2.new(0, 0, 0, 0)}):Play()
    end
end)

-- ===== Funciones de Highlight =====
local function setupCharacterListeners(player)
    if characterConnections[player] then
        characterConnections[player]:Disconnect()
    end
    
    characterConnections[player] = player.CharacterAdded:Connect(function(character)
        if isHighlightActive then
            character:WaitForChild("Humanoid")
            if not character:FindFirstChild("Highlight") then
                Instance.new("Highlight", character)
            end
            UpdateHighlights()
        end
    end)
end

function CreateHighlight()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LP then
            if player.Character then
                player.Character:WaitForChild("Humanoid")
                if not player.Character:FindFirstChild("Highlight") then
                    Instance.new("Highlight", player.Character)
                end
            end
            setupCharacterListeners(player)
        end
    end
end

function DeleteHighlight()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local highlight = player.Character:FindFirstChild("Highlight")
            if highlight then
                highlight:Destroy()
            end
        end
        if characterConnections[player] then
            characterConnections[player]:Disconnect()
            characterConnections[player] = nil
        end
    end
end

function UpdateHighlights()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LP and player.Character and player.Character:FindFirstChild("Humanoid") and player.Character:FindFirstChild("Highlight") then
            local Highlight = player.Character:FindFirstChild("Highlight")
            if player.Name == Sheriff and IsAlive(player) then
                Highlight.FillColor = Color3.fromRGB(0, 0, 255)
            elseif player.Name == Murder and IsAlive(player) then
                Highlight.FillColor = Color3.fromRGB(255, 0, 0)
            elseif player.Name == Hero and IsAlive(player) and not IsAlive(game.Players[Sheriff]) then
                Highlight.FillColor = Color3.fromRGB(255, 250, 0)
            else
                Highlight.FillColor = Color3.fromRGB(0, 255, 0)
            end
            Highlight.OutlineColor = Highlight.FillColor
            Highlight.FillTransparency = 0.5
            Highlight.OutlineTransparency = 0
            Highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end
    end
end

function IsAlive(player)
    for name, data in pairs(roles) do
        if player.Name == name then
            return not data.Killed and not data.Dead
        end
    end
    return false
end

-- ===== Actualizaciones de roles =====
LP.CharacterAdded:Connect(function(character)
    if isHighlightActive then
        CreateHighlight()
        UpdateHighlights()
    end
end)

Players.PlayerAdded:Connect(function(player)
    if isHighlightActive then
        setupCharacterListeners(player)
    end
end)

RunService.Heartbeat:Connect(function()
    local success, data = pcall(function()
        return ReplicatedStorage:FindFirstChild("GetPlayerData", true):InvokeServer()
    end)
    if success and data then
        roles = data
        for name, pdata in pairs(roles) do
            if pdata.Role == "Murderer" then
                Murder = name
            elseif pdata.Role == 'Sheriff' then
                Sheriff = name
            elseif pdata.Role == 'Hero' then
                Hero = name
            end
        end
    end
end)

-- ===== Funciones de arrastre =====
local function updateInput(input)
    if dragging then
        local delta = input.Position - dragStart
        buttonFrame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end

textButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = buttonFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

textButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateInput(input)
    end
end)

-- ===== Activar/Desactivar ESP =====
textButton.MouseButton1Click:Connect(function()
    if not isHighlightActive then
        isHighlightActive = true
        animateButton(true)
        CreateHighlight()
        
        if updateConnection then
            updateConnection:Disconnect()
        end
        
        updateConnection = RunService.Heartbeat:Connect(function()
            UpdateHighlights()
        end)
        
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LP then
                setupCharacterListeners(player)
            end
        end
    else
        isHighlightActive = false
        animateButton(false)
        
        if updateConnection then
            updateConnection:Disconnect()
            updateConnection = nil
        end
        
        DeleteHighlight()
    end
end)